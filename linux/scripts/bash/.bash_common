set -CEu
shopt -s xpg_echo

script_path=$(cd -- "$(dirname -- "${BASH_SOURCE[-1]}")" &> /dev/null && pwd)
script_name=$(basename "${BASH_SOURCE[-1]}")


################################################################################
### Log
################################################################################

_log() {
    local color_setup="${1}"; shift;
    local msg="${@}";
    [[ -t 1 ]] && tput setaf ${color_setup}
    printf "${msg}\n" >&2
    [[ -t 1 ]] && tput sgr0
}

log_header() { _log 3 "@ ${@}";   }  # Yellow
log_info()   { _log 2 ">> ${@}";  }  # Green
log_warn()   { _log 5 "W · ${@}"; }  # Purple
log_error()  { _log 1 "E · ${@}"; }  # Red
error_exit() { log_error "${@}"; exit 1; }


################################################################################
### Required
################################################################################

REQUIRED_VERBOSE=false

declare -A _REQUIRED_LABELS=(
    [file]="File"
    [dir]="Dir"
    [var]="Var"
    [cmd]="Cmd"
    [notemptydir]="NotEmptyDir"
)

_required() {
    local op="${1,,}" elem="$2" info="${3:-}"
    local label="${_REQUIRED_LABELS[$op]:-$op}"

    local ok=$(_is "$op" "$elem")
    [[ $ok == 0 ]] || error_exit "${label} not found '${elem}'${info:+ <-- $info}"
    [[ $ok == 0 && $REQUIRED_VERBOSE == true ]] && log_info "${label} found '${elem}'"
}

_is() {
    local op="${1,,}"
    local elem="$2"
    case "${op}" in
        file)        [[ -f "${elem}" ]] ;;
        dir)         [[ -d "${elem}" ]] ;;
        var)         [[ -n "${elem}" ]] ;;
        cmd)         command -v "${elem}" >/dev/null 2>&1 ;;
        notemptydir) [[ -d "${elem}" ]] && [[ -n "$(ls -A "${elem}" 2>/dev/null)" ]] ;;
        *)           return 1 ;;
    esac
}

for type in "${!_REQUIRED_LABELS[@]}"; do
    eval "is_${type}() { _is '${type}' \"\$@\"; }"
    eval "required_${type}() { _required '${type}' \"\$@\"; }"
done


################################################################################
### Git
################################################################################

is_git() {
    required_cmd "git"
    git rev-parse --is-inside-work-tree > /dev/null 2>&1
}
guard__is_git() {
    is_git || error_exit "Current directory is not a git repository"
}

repo_root() {
    echo "$(git -C "${script_path}" rev-parse --show-toplevel 2>/dev/null)"
}
repo_parent() {
    root="$(repo_root)"
    [[ -n "${root}" ]] && echo "$(dirname "${root}")" || echo "${script_path}"
}
repo_branch() {
    echo "$(git -C "${script_path}" branch --show-current)"
}


################################################################################
### Interactive
################################################################################

_find_dir_name_only() {
    local dir="${1}"
    local pattern="${2:-*}"
    find "${dir}" -mindepth 1 -maxdepth 1 -type d -name "${pattern}" -printf '%P\n'
}

fzf_default() {
    required_cmd "fzf"
    fzf -1 --layout=reverse --cycle --info=inline-right --height $(min $(tput lines) 20)
}
choose_one() {
    echo "$(printf "%s\n" "${@}" | fzf_default)"
}
choose_from_dir() {
    [[ "${#}" < 1 ]] && { error_exit "Usage: choose_from_dir DIR"; }
    echo "${1}/$(choose_from_dir_tail "${1}")"
}
choose_from_dir_tail() {
    [[ "${#}" < 1 ]] && { error_exit "Usage: choose_from_dir_tail DIR"; }
    echo "$(_find_dir_name_only "${1}" | fzf_default)"
}
choose_from_dir_glob() {
    [[ "${#}" < 2 ]] && { error_exit "Usage: choose_from_dir_glob DIR PATTERN"; }
    echo "${1}/$(_find_dir_name_only "${1}" "${2}" | fzf_default)"
}


################################################################################
### Misc
################################################################################

show_and_copy() {
    echo "$1"
    if command -v xclip >/dev/null 2>&1; then
        echo "$1" | xclip -selection c
    fi
}

max() {
    echo $(( $1 > $2 ? $1 : $2 ))
}
min() {
    echo $(( $1 < $2 ? $1 : $2 ))
}
clamp() {
  local value=$1; shift
  local low=$1  ; shift
  local high=$1 ; shift
  min $(max $value $low) $high
}
