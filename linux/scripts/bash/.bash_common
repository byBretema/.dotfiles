
set -CEeuo pipefail
shopt -s xpg_echo

script_path=$(cd -- "$(dirname -- "${BASH_SOURCE[-1]}")" &> /dev/null && pwd)
script_name=$(basename "${BASH_SOURCE[-1]}")


################################################################################
### Log
################################################################################

log_header() { printf "@ \033[0;33m%s\033[0m\n" "${1}"; }
log_info  () { printf ">> \033[0;35m%s\033[0m\n" "${1}"; }
log_error () { printf "E Â· \033[1;31m%s\033[0m\n" "${1}"; }
error_exit() { log_error "${1}"; exit 1; }


################################################################################
### Required
################################################################################

REQUIRED_VERBOSE=false

required() {
  local op="${1}" elem="$2" info="${3:-}"
  [[ -n "${info}" ]] && info=" <--  ${info}"

  local op_log="${op}"
  local op="${op,,}"

  local ok=1
  [[ "${op}" == "file"        ]] && [[ -f "${elem}" ]] && ok=0
  [[ "${op}" == "dir"         ]] && [[ -d "${elem}" ]] && ok=0
  [[ "${op}" == "var"         ]] && [[ -n "${elem}" ]] && ok=0
  [[ "${op}" == "cmd"         ]] && command -v "${elem}" >/dev/null 2>&1 && ok=0
  [[ "${op}" == "notemtpydir" ]] && [[ -d "${elem}" ]] && [[ -n "$(ls -A "${elem}")" ]] && ok=0;

  local L="${op_log[@]^}"
  local R="found '${elem}'"
  [[ $ok != 0 ]] && error_exit "${L} not ${R}${info}"
  [[ $ok == 0 && $REQUIRED_VERBOSE == true ]] && log_info "${L} ${R}"
}

required_file()          { required "File"          "$@"; }
required_dir()           { required "Dir"           "$@"; }
required_dir_notempty()  { required "NotEmtpyDir" "$@"; }
required_var()           { required "Var"           "$@"; }
required_cmd()           { required "Cmd"           "$@"; }


################################################################################
### Git
################################################################################

is_git() {
  required_cmd "git"
  git rev-parse --is-inside-work-tree > /dev/null 2>&1
}

guard__is_git() {
  is_git || error_exit "Current directory is not a git repository"
}

repo_root() {
  echo "$(git -C "${script_path}" rev-parse --show-toplevel 2>/dev/null)"
}

repo_parent() {
  root="$(repo_root)"
  [[ -n "${root}" ]] && echo "$(dirname "${root}")" || echo "${script_path}"
}


################################################################################
### Misc
################################################################################

show_and_copy() {
  echo "$1"
  if command -v xclip >/dev/null 2>&1; then
    echo "$1" | xclip -selection c
  fi
}
